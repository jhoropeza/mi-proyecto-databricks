# .github/workflows/ci-cd-databricks.yml
# ----------------------------------------------------------------------
name: Databricks CI/CD con Aprobación (Final)

on:
  # CI TRIGGER: Se activa para integración y despliegue a DEV
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    
  # CD TRIGGER: Se activa SÓLO cuando se crea un tag (release)
  release:
    types: [created] 

env:
  # Variables del entorno
  NOTEBOOK_PATH: notebooks/ingestion/main_ingestion.py
  PYTHON_VERSION: '3.9' 
  
jobs:
  # ===================================================================
  # 1. BUILD, TEST & DESPLIEGUE A DEV (CI Phase)
  # ===================================================================
  build_and_deploy_dev:
    name: 'CI, Test & Despliegue a DEV'
    runs-on: ubuntu-latest
    environment: dev # Usa secretos DBR_HOST_DEV y DBR_TOKEN_DEV
    
    steps:
      - name: '1. Checkout del Código'
        uses: actions/checkout@v4
      
      - name: '2. Configurar Python ${{ env.PYTHON_VERSION }}'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: '3. Instalar Dependencias (requirements.txt)'
        run: pip install -r requirements.txt
        
      - name: '4. Ejecutar Pruebas (pytest)'
        run: pytest tests/
        
      # 5. INSTALACIÓN DE CLI Y CREACIÓN DE DIRECTORIOS
      - name: '5. Instalar Databricks CLI'
        uses: databricks/setup-cli@main # Usando la referencia funcional @main
        
      # 6. SOLUCIÓN DE RUTA: CREAR SOLO EL DIRECTORIO (Folder)
      - name: '6. Crear Directorio Base Completo'
        env:
          DATABRICKS_HOST: ${{ secrets.DBR_HOST_DEV }}
          DATABRICKS_TOKEN: ${{ secrets.DBR_TOKEN_DEV }}
        run: |
          # Creamos la ruta completa hasta el directorio /DEV
          DBR_TARGET_DIR=/Shared/CI-CD/${{ github.repository_id }}/DEV
          databricks workspace mkdirs ${DBR_TARGET_DIR} # ¡Garantiza que la carpeta exista!
          echo "Directorio contenedor ${DBR_TARGET_DIR} creado."

      - name: '7. Desplegar Notebook a DEV'
        env:
          DATABRICKS_HOST: ${{ secrets.DBR_HOST_DEV }}
          DATABRICKS_TOKEN: ${{ secrets.DBR_TOKEN_DEV }}
        run: |
          # La ruta de destino incluye el nombre del archivo final
          DBR_TARGET_FILE=/Shared/CI-CD/${{ github.repository_id }}/DEV/main_ingestion.py
          
          databricks workspace import \
            --language PYTHON \
            --overwrite \
            --file "${NOTEBOOK_PATH}" \
            "${DBR_TARGET_FILE}" 
          echo "Notebook desplegado en DEV: ${DBR_TARGET_FILE}"
            
  # ===================================================================
  # 2. DESPLIEGUE CONTINUO (CD) A PRODUCCIÓN
  # ===================================================================
  deploy_to_prod:
    name: 'CD a PRODUCCIÓN (Requiere Aprobación)'
    runs-on: ubuntu-latest
    
    # Condición crucial: Solo se ejecuta si el evento fue 'release' y el Job de DEV fue exitoso.
    if: success() && github.event_name == 'release'
    needs: [build_and_deploy_dev] 
    
    environment: 
      name: prod # Activa la aprobación manual
      
    steps:
      - name: '1. Checkout del Código'
        uses: actions/checkout@v4
      
      # 2. INSTALACIÓN Y CREACIÓN DE DIRECTORIOS
      - name: '2. Instalar Databricks CLI'
        uses: databricks/setup-cli@main
        
      - name: '3. Crear Directorio Base Completo'
        env:
          DATABRICKS_HOST: ${{ secrets.DBR_HOST_PROD }}
          DATABRICKS_TOKEN: ${{ secrets.DBR_TOKEN_PROD }}
        run: |
          DBR_TARGET_DIR=/Shared/CI-CD/${{ github.repository_id }}/PROD
          databricks workspace mkdirs ${DBR_TARGET_DIR}
          echo "Directorio contenedor ${DBR_TARGET_DIR} creado."
        
      - name: '4. Desplegar Notebook a PROD'
        env:
          DATABRICKS_HOST: ${{ secrets.DBR_HOST_PROD }}
          DATABRICKS_TOKEN: ${{ secrets.DBR_TOKEN_PROD }}
        run: |
          DBR_TARGET_FILE=/Shared/CI-CD/${{ github.repository_id }}/PROD/main_ingestion.py
          
          databricks workspace import \
            --language PYTHON \
            --overwrite \
            --file "${NOTEBOOK_PATH}" \
            "${DBR_TARGET_FILE}"
          echo "Notebook desplegado en PROD: ${DBR_TARGET_FILE}"